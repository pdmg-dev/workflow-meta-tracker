{% extends 'base.html' %}
{% block content %}
  <div class="content-container">
    <div class="content-header">
      <h4 class="content-title">Dashboard</h4>
      {% if 'encoder' or 'admin' in current_user.roles | map(attribute='code') | list %}
        <a href="{{ url_for('voucher.new_voucher') }}" class="btn btn-primary">
          <i class="plus-icon bi bi-file-earmark-plus me-1"></i>New Voucher
        </a>
      {% endif %}
    </div>

    <div class="fragments">
      <div class="left-panel">
        {% include 'dashboard/summary.html' %}
        <div class="card">
          <h6 class="card-header">Recent Vouchers</h6>
          <div class="d-flex justify-content-between">
            <div class="d-flex justify-content-left gap-2 ps-3">
              <button
                class="btn btn-primary btn-sm"
                hx-post="{{ url_for('voucher.bulk_update_status') }}"
                hx-target="#table-container"
                hx-swap="innerHTML"
                hx-include="#update-status-form"
              >
                <i class="bi bi-arrow-up-circle"></i>
                Update Status
              </button>
            </div>
            <div class="d-flex justify-content-right gap-2 pe-3">
              <div class="position-relative">
                <input type="text" id="voucher-search" class="form-control form-control-sm" placeholder="Search..." />
              </div>
            </div>
          </div>
          <div class="card-body">
            <div id="table-container" class="table-container scroll-area">{% include 'voucher/_table.html' %}</div>
          </div>
        </div>
      </div>

      <div class="right-panel">
        <div class="row g-3">
          <div class="col-6 d-flex">
            <div class="card">
              <h6 class="card-header">Voucher Compliance</h6>
              <div class="card-body">
                <div class="row">
                  <div class="col-4">Expired</div>
                  <div class="col-4">Incomplete</div>
                  <div class="col-4">Invalid</div>
                </div>
                <div class="row">
                  <div class="col-6">
                    <h3 class="d-inline">{{ voucher_status["approved"].count() }}</h3>
                    <span class="fr-pend">Released Vouchers</span>
                  </div>
                  <div class="col-6">
                    <h3 class="d-inline">{{ voucher_status["pending"] }}</h3>
                    <span class="fr-pend">Pending Vouchers</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-6 d-flex">
            <div class="card">
              <h6 class="card-header">Voucher Compliance</h6>
              <div class="card-body">
                <div class="row">
                  <div class="col-4">Expired</div>
                  <div class="col-4">Incomplete</div>
                  <div class="col-4">Invalid</div>
                </div>
                <div class="row">
                  <div class="col-6">
                    <h3 class="d-inline">{{ voucher_status["approved"].count() }}</h3>
                    <span class="fr-pend">Released Vouchers</span>
                  </div>
                  <div class="col-6">
                    <h3 class="d-inline">{{ voucher_status["pending"] }}</h3>
                    <span class="fr-pend">Pending Vouchers</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card" id="particulars">
          <h6 class="card-header text-muted"></h6>
          <div class="card-body">
            <canvas id="statusChart" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block style %}
  <style>
    .fragments {
      display: grid;
      grid-template-columns: 3fr 2fr;
      gap: 1rem;
      min-height: 0;
      overflow: hidden;
    }

    .left-panel {
      display: grid;
      grid-template-rows: 1fr 3fr;
      gap: 1rem;
      min-height: 0;
    }

    .right-panel {
      display: grid;
      grid-template-rows: 2fr 3fr;
      gap: 1rem;
      min-height: 0;
    }

    .count {
      color: #6c757d;
    }

    .fr-pend {
      font-size: smaller;
      color: #6c757d;
    }

    .file-earmark {
      color: #6c757d;
    }

    /* #Global - Table container with sticky header and scrollable body */
    .table-container {
      display: grid;
      grid-template-rows: auto minmax(0, 1fr); /* Header + Scrollable Table */
      background-color: white;
      overflow: hidden;
      font-size: small;
    }

    .scroll-area {
      overflow-y: auto;
      min-height: 0;
      flex-grow: 1;
      overflow-x: hidden;
      scrollbar-width: none;
    }

    .scroll-area::-webkit-scrollbar {
      display: none;
      border-radius: inherit;
      overflow: hidden;
    }
  </style>
{% endblock %}

{% block script %}
  <script>
    fetch("/chart-data")
      .then((response) => response.json())
      .then((data) => {
        const labels = Object.keys(data);
        const values = Object.values(data);

        new Chart(document.getElementById("statusChart"), {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Voucher Status Count",
                data: values,
                backgroundColor: "rgba(54, 162, 235, 0.5)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      });
  </script>
{% endblock %}
