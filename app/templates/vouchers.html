{# app/templates/vouchers.html #}
{% extends "base.html" %}

{% block content %}
  <div class="content-container">
    <div class="content-header">
      <h4 class="content-title">Disbursement Vouchers</h4>
      {% set role_codes = current_user.roles | map(attribute='code') | list %}
      {% if 'encoder' in role_codes or 'admin' in role_codes %}
        <a href="{{ url_for('voucher.new_voucher') }}" class="btn btn-primary">
          <i class="plus-icon bi bi-file-earmark-plus me-1"></i>New Voucher
        </a>
      {% endif %}
    </div>

    <div class="fragments">
      <div class="card">
        <h6 class="card-header">All Vouchers</h6>

        <div class="d-flex justify-content-between px-3">
          <div class="d-flex justify-content-left gap-2">
            <button
              class="btn btn-primary"
              hx-post="{{ url_for('voucher.bulk_update_status') }}"
              hx-include="#update-status-form"
              hx-swap="none"
            >
              <i class="bi bi-arrow-up-circle"></i> Update Status
            </button>
          </div>

          <div class="d-flex justify-content-right gap-2">
            <div class="position-relative">
              <input type="text" id="voucher-search" class="form-control" placeholder="Search..." />
              <button
                id="clear-search"
                class="clear-search btn btn-sm position-absolute end-0 top-0 mt-1 me-1"
                type="button"
              >
                <i class="bi bi-x-circle"></i>
              </button>
            </div>

            <div class="dropdown">
              <button
                class="btn btn-outline-secondary dropdown-toggle"
                type="button"
                id="dropdownMenuButton"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                Filter by
              </button>
              <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <li><a class="dropdown-item" href="#">All</a></li>
                <li><a class="dropdown-item" href="#">Received</a></li>
                <li><a class="dropdown-item" href="#">Checked</a></li>
                <li><a class="dropdown-item" href="#">Sorted</a></li>
                <li><a class="dropdown-item" href="#">Approved</a></li>
                <li><a class="dropdown-item" href="#">Returned</a></li>
              </ul>
            </div>
          </div>
        </div>

        <div class="card-body">
          <div id="table-container" class="table-container scroll-area" hx-target="this">
            {% include 'voucher/_table.html' %}
          </div>
        </div>
      </div>

      <div class="card">
        <h6 class="card-header">Details</h6>
        <div class="card-body">
          <div id="voucher-details-preview" class="h-100">
            {% if voucher %}
              {% include "voucher/fragments/preview.html" %}
            {% else %}
              <div>No voucher to show.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="modal-container"></div>
{% endblock %}

{% block script %}
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      ensureVoucherRowIds();
      initializeVoucherTable();
      bindVoucherSearchInput();
      initVoucherSorting();
      initVoucherDropdownFilter();
      bindClearSearchButton();
    });

    /* ------------------------------------------------
     * Utility: Ensure each table row has an ID
     * ------------------------------------------------ */
    function ensureVoucherRowIds() {
      document.querySelectorAll(".voucher-row").forEach((row) => {
        if (!row.id && row.dataset.voucherId) {
          row.id = `voucher-${row.dataset.voucherId}`;
        }
      });
    }

    /* ------------------------------------------------
     * Voucher Table: Selection, Navigation, Updates
     * ------------------------------------------------ */
    function initializeVoucherTable() {
      const tableContainer = document.querySelector("#table-container");
      if (!tableContainer) return;

      // Store shared state on the container
      tableContainer._voucherState = tableContainer._voucherState || {
        activeVoucherId: null,
        rowSelector: ".voucher-row",
      };

      /* --- Handle row clicks --- */
      tableContainer.removeEventListener("click", tableContainer._voucherState._clickHandler);
      tableContainer._voucherState._clickHandler = (event) => {
        if (event.target.closest(".dropdown, .dropdown-menu, [data-bs-toggle='modal'], .modal")) return;

        const clickedRow = event.target.closest(tableContainer._voucherState.rowSelector);
        if (!clickedRow) return;

        activateVoucherById(clickedRow.dataset.voucherId, tableContainer);
      };
      tableContainer.addEventListener("click", tableContainer._voucherState._clickHandler);

      /* --- Keyboard navigation --- */
      if (!window._voucherKeyboardBound) {
        window._voucherKeyboardBound = true;
        window.addEventListener("keydown", handleVoucherKeyboardNavigation);
      }

      /* --- “Select All” checkbox --- */
      if (!document._selectAllBound) {
        document._selectAllBound = true;
        document.addEventListener("change", (e) => {
          if (e.target.id === "select-all") {
            document
              .querySelectorAll("#update-status-form input[name='voucher_ids']")
              .forEach((checkbox) => (checkbox.checked = e.target.checked));
          }
        });
      }

      /* --- Live JSON response updates --- */
      if (!window._voucherJsonHandlerBound) {
        window._voucherJsonHandlerBound = true;
        document.body.addEventListener("htmx:afterRequest", handleVoucherJsonResponse);
        document.body.addEventListener("htmx:afterOnLoad", handleVoucherJsonResponse);
      }
    }

    /* ------------------------------------------------
     * Focus + Navigation Helpers
     * ------------------------------------------------ */
    function handleVoucherKeyboardNavigation(event) {
      const tableContainer = document.querySelector("#table-container");
      if (!tableContainer?._voucherState) return;

      const rows = Array.from(tableContainer.querySelectorAll(tableContainer._voucherState.rowSelector));
      if (!rows.length || !tableContainer._voucherState.activeVoucherId) return;

      const currentIndex = rows.findIndex(
        (row) => row.dataset.voucherId === tableContainer._voucherState.activeVoucherId,
      );
      if (currentIndex === -1) return;

      if (event.key === "ArrowDown") {
        event.preventDefault();
        setActiveVoucherByIndex(Math.min(currentIndex + 1, rows.length - 1), tableContainer);
      } else if (event.key === "ArrowUp") {
        event.preventDefault();
        setActiveVoucherByIndex(Math.max(currentIndex - 1, 0), tableContainer);
      }
    }

    function activateVoucherById(voucherId, container) {
      const rows = Array.from(container.querySelectorAll(container._voucherState.rowSelector));
      const index = rows.findIndex((row) => row.dataset.voucherId === String(voucherId));
      if (index !== -1) setActiveVoucherByIndex(index, container);
    }

    function setActiveVoucherByIndex(index, container) {
      const rows = Array.from(container.querySelectorAll(container._voucherState.rowSelector));
      if (!rows[index]) return;

      rows.forEach((row) => row.classList.remove("active-row"));
      const activeRow = rows[index];
      activeRow.classList.add("active-row");
      container._voucherState.activeVoucherId = String(activeRow.dataset.voucherId);

      activeRow.scrollIntoView({ block: "nearest" });
      try {
        activeRow.focus({ preventScroll: true });
      } catch {}

      const modalOpen = document.querySelector(".modal.show");
      const dropdownOpen = document.querySelector(".dropdown-menu.show");
      if (modalOpen || dropdownOpen) return;

      if (activeRow.dataset.voucherId) {
        htmx.ajax("GET", `/voucher/${activeRow.dataset.voucherId}/particulars`, "#voucher-details-preview");
      }
    }

    /* ------------------------------------------------
     * Handle JSON response for live status updates
     * ------------------------------------------------ */
    function handleVoucherJsonResponse(event) {
      const xhr = event.detail?.xhr;
      const contentType = xhr?.getResponseHeader("content-type") || "";
      if (!contentType.includes("application/json")) return;

      let data;
      try {
        data = JSON.parse(xhr.responseText || "{}");
      } catch {
        return;
      }
      if (!data.updated || !Array.isArray(data.updated)) return;

      data.updated.forEach(({ id, status, code, updated_at }) => {
        const badge = document.querySelector(`.voucher-row[data-voucher-id="${id}"] .status-col .badge`);
        const updatedAt = document.querySelector(`.voucher-row[data-voucher-id="${id}"] .status-col .updated_at`);
        if (!badge) return;

        badge.textContent = status;
        badge.className = "badge " + getStatusColorClass(code);
        badge.classList.add("flash");
        setTimeout(() => badge.classList.remove("flash"), 1000);

        if (updatedAt && updated_at) updatedAt.textContent = updated_at;
      });
    }

    function getStatusColorClass(code) {
      switch (code) {
        case "checked":
          return "bg-primary";
        case "sorted":
          return "bg-warning";
        case "approved":
          return "bg-success";
        case "returned":
          return "bg-danger";
        default:
          return "bg-secondary";
      }
    }

    /* ------------------------------------------------
     * Search Filter (respects dropdown filter)
     * ------------------------------------------------ */
    function bindVoucherSearchInput() {
      const searchInput = document.getElementById("voucher-search");
      const clearBtn = document.getElementById("clear-search");
      if (!searchInput || searchInput._bound) return;
      searchInput._bound = true;

      const filterRows = () => {
        const query = searchInput.value.trim().toLowerCase();
        const activeFilter = localStorage.getItem("voucherDropdownFilter") || "All";

        document.querySelectorAll(".voucher-row").forEach((row) => {
          const text = row.textContent.toLowerCase();
          const statusCell = row.querySelector(".status-col .badge");
          const statusText = statusCell ? statusCell.textContent.trim() : "";

          const matchesSearch = !query || text.includes(query);
          const matchesFilter = activeFilter === "All" || statusText === activeFilter;

          // Show if both match
          row.style.display = matchesSearch && matchesFilter ? "" : "none";
        });

        // Toggle clear button visibility
        clearBtn.style.visibility = query ? "visible" : "hidden";
      };

      searchInput.addEventListener("input", filterRows);

      // Clear button: only clears search box, doesn't reload table
      clearBtn.addEventListener("click", () => {
        if (!searchInput.value) return; // do nothing if already empty
        searchInput.value = "";
        filterRows();
      });

      // Initialize button hidden
      clearBtn.style.visibility = "hidden";
    }

    function initVoucherDropdownFilter() {
      const button = document.getElementById("dropdownMenuButton");
      const STORAGE_KEY = "voucherDropdownFilter";

      if (!button) {
        console.warn("Voucher filter button not found!");
        return;
      }

      // Find the menu *linked* to this button
      const dropdownMenu = document.querySelector(`[aria-labelledby="${button.id}"]`);
      if (!dropdownMenu) {
        console.warn("Voucher filter menu not found!");
        return;
      }

      // Restore last-used filter if stored
      const savedFilter = localStorage.getItem(STORAGE_KEY);
      if (savedFilter) {
        button.textContent = savedFilter === "All" ? "Filter by" : `Filter: ${savedFilter}`;
        applyVoucherFilter(savedFilter);
      }

      // ✅ Attach click listener only to this dropdown menu
      dropdownMenu.addEventListener("click", (e) => {
        const item = e.target.closest(".dropdown-item");
        if (!item) return;

        e.preventDefault(); // prevent link nav
        e.stopPropagation(); // avoid Bootstrap swallowing it

        const filter = item.textContent.trim();
        console.log("   Voucher dropdown clicked:", filter);

        // Save + show
        localStorage.setItem(STORAGE_KEY, filter);
        button.textContent = filter === "All" ? "Filter by" : `Filter: ${filter}`;

        // Apply filtering
        applyVoucherFilter(filter);

        // Close the dropdown after click
        const dropdownInstance = bootstrap.Dropdown.getInstance(button);
        if (dropdownInstance) {
          dropdownInstance.hide();
        }
      });
    }

    function applyVoucherFilter(filter) {
      const rows = document.querySelectorAll(".voucher-row");

      rows.forEach((row) => {
        const statusCell = row.querySelector(".status-col .badge");
        const statusText = statusCell ? statusCell.textContent.trim() : "";

        // Show all if filter is "All"
        if (filter === "All" || statusText === filter) {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      });
    }

    // Close modal
    function handleReturnResponse(event) {
      const detail = event.detail;
      if (!detail.xhr) return;

      // only handle successful JSON responses
      if (detail.xhr.status === 200 && detail.xhr.getResponseHeader("content-type").includes("application/json")) {
        // Close the Bootstrap modal
        const modalEl = document.getElementById("dynamicModal");
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();

        // Optional: update your UI (badge, row, etc.)
        const response = JSON.parse(detail.xhr.responseText);
        const updated = response.updated?.[0];
        if (updated) {
          const row = document.querySelector(`[data-voucher-id="${updated.id}"]`);
          if (row) {
            row.querySelector(".status-cell").textContent = updated.status;
            row.querySelector(".updated-at-cell").textContent = updated.updated_at;
          }
        }
      }
    }

    /* ------------------------------------------------
     * Table Sorting (Client-Side)
     * ------------------------------------------------ */
    function initVoucherSorting() {
      const headers = document.querySelectorAll(".voucher-table th.sortable");
      if (!headers.length) return;

      headers.forEach((th) => {
        th.addEventListener("click", () => handleVoucherSort(th));
      });

      // ✅ Restore saved sort
      const savedSort = JSON.parse(localStorage.getItem("voucherSortState") || "{}");
      if (savedSort.key && savedSort.dir) {
        const targetHeader = Array.from(headers).find((th) => th.dataset.sort === savedSort.key);
        if (targetHeader) {
          targetHeader.dataset.dir = savedSort.dir;
          handleVoucherSort(targetHeader, true); // true = restore mode (no re-toggle)
        }
      }
    }

    function handleVoucherSort(th, restore = false) {
      const table = th.closest("table");
      const tableBody = table.querySelector("tbody");
      const rows = Array.from(tableBody.querySelectorAll("tr.voucher-row"));
      const sortKey = th.dataset.sort;

      // ✅ Save original order (only once)
      if (!table._originalOrder) {
        table._originalOrder = rows.map((row) => row);
      }

      // ✅ Determine direction (3-state: none → asc → desc → none)
      let currentDir;
      if (restore) {
        currentDir = th.dataset.dir || "asc";
      } else {
        if (!th.dataset.dir) currentDir = "asc";
        else if (th.dataset.dir === "asc") currentDir = "desc";
        else currentDir = "none";
      }

      // ✅ Clear all other header states
      table.querySelectorAll("th.sortable").forEach((header) => {
        if (header !== th) delete header.dataset.dir;
        const icon = header.querySelector("i");
        if (icon) icon.classList.replace("opacity-100", "opacity-0");
      });

      // ✅ If “none” → restore original order
      if (currentDir === "none") {
        delete th.dataset.dir;
        localStorage.removeItem("voucherSortState");

        const icon = th.querySelector("i");
        if (icon) icon.classList.replace("opacity-100", "opacity-0");

        tableBody.innerHTML = "";
        tableBody.append(...table._originalOrder);
        return;
      }

      // ✅ Update dataset + persist
      th.dataset.dir = currentDir;
      localStorage.setItem("voucherSortState", JSON.stringify({ key: sortKey, dir: currentDir }));

      // ✅ Update active icon
      const icon = th.querySelector("i");
      if (icon) {
        icon.classList.replace("opacity-0", "opacity-100");
        icon.classList.toggle("bi-caret-down-fill", currentDir === "desc");
        icon.classList.toggle("bi-caret-up-fill", currentDir === "asc");
      }

      // ✅ Extract sort value
      const getValue = (row) => {
        switch (sortKey) {
          case "amount":
            return parseFloat(row.querySelector(".amount-col")?.textContent.replace(/,/g, "")) || 0;
          case "date":
            return new Date(row.querySelector(".date-col")?.textContent.trim()).getTime() || 0;
          case "status":
            return row.querySelector(".status-col .badge")?.textContent.trim().toLowerCase() || "";
          case "type":
            return row.querySelector(".type")?.textContent.trim().toLowerCase() || "";
          case "voucher-id":
            return row.querySelector(".voucher-id")?.textContent.trim().toLowerCase() || "";
          case "payee":
            return row.querySelector(".payee-col")?.textContent.trim().toLowerCase() || "";
          case "origin":
            return row.querySelector(".origin")?.textContent.trim().toLowerCase() || "";
          default:
            return row.textContent.trim().toLowerCase();
        }
      };

      // ✅ Sort rows
      rows.sort((a, b) => {
        const aVal = getValue(a);
        const bVal = getValue(b);
        if (typeof aVal === "number" && typeof bVal === "number") {
          return currentDir === "asc" ? aVal - bVal : bVal - aVal;
        }
        return currentDir === "asc"
          ? aVal.localeCompare(bVal, undefined, { numeric: true })
          : bVal.localeCompare(aVal, undefined, { numeric: true });
      });

      // ✅ Update table
      tableBody.append(...rows);
    }

    // Clear search button bind

    function bindClearSearchButton() {
      const clearBtn = document.getElementById("clear-search");
      const searchInput = document.getElementById("voucher-search");
      if (!clearBtn || clearBtn._bound) return;
      clearBtn._bound = true;

      clearBtn.addEventListener("click", (e) => {
        e.preventDefault();
        if (!searchInput) return;
        searchInput.value = "";
        // Fire both input + search to cover both behaviors
        searchInput.dispatchEvent(new Event("input"));
        searchInput.dispatchEvent(new Event("search"));
      });
    }

    /* ------------------------------------------------
     * Handle HTMX Table Swap & Modal Restore
     * ------------------------------------------------ */
    document.body.addEventListener("htmx:afterSwap", (e) => {
      if (e.target.id === "table-container") {
        ensureVoucherRowIds();
        initializeVoucherTable();
        bindVoucherSearchInput();
        initVoucherSorting();
        initVoucherDropdownFilter();
        bindClearSearchButton();
      }
    });

    document.body.addEventListener("hidden.bs.modal", () => {
      const container = document.querySelector("#table-container");
      const activeId = container?._voucherState?.activeVoucherId;
      if (activeId) {
        const activeRow = document.querySelector(`#voucher-${activeId}`);
        if (activeRow) activeRow.focus({ preventScroll: true });
      }
    });

    document.body.addEventListener("htmx:afterSwap", (event) => {
      // When modal HTML is swapped into the modal container...
      if (event.target.id === "modal-container") {
        const modalEl = document.querySelector(".modal");
        if (modalEl) {
          // Get or create Bootstrap modal instance
          const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
          modal.show();
        }
      }
    });

    // Optional: clean up modal DOM after it's closed
    document.body.addEventListener("hidden.bs.modal", (event) => {
      event.target.remove(); // remove modal markup after hide
    });
  </script>
{% endblock %}

{% block style %}
  <style>
    .fragments {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 1rem;
      min-height: 0;
      overflow: hidden;
    }

    .plus-icon {
      vertical-align: middle;
    }

    .flash {
      animation: flash-bg 1s ease-in-out;
    }
    @keyframes flash-bg {
      from {
        background-color: #ffffa0;
      }
      to {
        background-color: inherit;
      }
    }

    .clear-search {
      background-color: white;
      outline-color: white;
      border: none;
      translate: unset;
      box-shadow: none;
      color: #dee2e6;
      align-items: center;
    }

    .clear-search.disabled {
      opacity: 0.3;
      pointer-events: none;
    }
  </style>
{% endblock %}
