{# app/templates/vouchers.html #}
{% extends "base.html" %}

{% block content %}
  <div class="content-container">
    <div class="content-header">
      <h4 class="content-title">Disbursement Vouchers</h4>
      {% set role_codes = current_user.roles | map(attribute='code') | list %}
      {% if 'encoder' in role_codes or 'admin' in role_codes %}
        <a href="{{ url_for('voucher.new_voucher') }}" class="btn btn-primary">
          <i class="plus-icon bi bi-file-earmark-plus me-1"></i>New Voucher
        </a>
      {% endif %}
    </div>

    <div class="fragments">
      <div class="card">
        <h6 class="card-header">All Vouchers</h6>

        <div class="d-flex justify-content-between">
          <div class="d-flex justify-content-left gap-2 ps-3">
            <button
              class="btn btn-primary"
              hx-post="{{ url_for('voucher.bulk_update_status') }}"
              hx-include="#update-status-form"
              hx-swap="none"
            >
              <i class="bi bi-arrow-up-circle"></i> Update Status
            </button>
          </div>

          <div class="d-flex justify-content-right gap-2 pe-3">
            <div class="position-relative">
              <input type="text" id="voucher-search" class="form-control" placeholder="Search..." />
            </div>

            <div class="dropdown">
              <button
                class="btn btn-outline-secondary dropdown-toggle"
                type="button"
                id="dropdownMenuButton"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                Sort by
              </button>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                <li><a class="dropdown-item" href="#">Payee</a></li>
                <li><a class="dropdown-item" href="#">Amount</a></li>
                <li><a class="dropdown-item" href="#">Origin</a></li>
              </ul>
            </div>
          </div>
        </div>

        <div class="card-body">
          <div id="table-container" class="table-container scroll-area">{% include 'voucher/_table.html' %}</div>
        </div>
      </div>

      <div class="card">
        <h6 class="card-header">Details</h6>
        <div class="card-body">
          <div id="voucher-details-preview" class="h-100">
            {% if voucher %}
              {% include "voucher/fragments/preview.html" %}
            {% else %}
              <div>No voucher to show.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="modal-container"></div>
{% endblock %}

{% block script %}
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      ensureVoucherRowIds();
      initializeVoucherTable();
      bindVoucherSearchInput();
    });

    /* ------------------------------------------------
     * Utility: Ensure each table row has an ID
     * ------------------------------------------------ */
    function ensureVoucherRowIds() {
      document.querySelectorAll(".voucher-row").forEach((row) => {
        if (!row.id && row.dataset.voucherId) {
          row.id = `voucher-${row.dataset.voucherId}`;
        }
      });
    }

    /* ------------------------------------------------
     * Voucher Table: Selection, Navigation, Updates
     * ------------------------------------------------ */
    function initializeVoucherTable() {
      const tableContainer = document.querySelector("#table-container");
      if (!tableContainer) return;

      // Store shared state on the container
      tableContainer._voucherState = tableContainer._voucherState || {
        activeVoucherId: null,
        rowSelector: ".voucher-row",
      };

      /* --- Handle row clicks --- */
      tableContainer.removeEventListener("click", tableContainer._voucherState._clickHandler);
      tableContainer._voucherState._clickHandler = (event) => {
        if (event.target.closest(".dropdown, .dropdown-menu, [data-bs-toggle='modal'], .modal")) return;

        const clickedRow = event.target.closest(tableContainer._voucherState.rowSelector);
        if (!clickedRow) return;

        activateVoucherById(clickedRow.dataset.voucherId, tableContainer);
      };
      tableContainer.addEventListener("click", tableContainer._voucherState._clickHandler);

      /* --- Keyboard navigation --- */
      if (!window._voucherKeyboardBound) {
        window._voucherKeyboardBound = true;
        window.addEventListener("keydown", handleVoucherKeyboardNavigation);
      }

      /* --- “Select All” checkbox --- */
      if (!document._selectAllBound) {
        document._selectAllBound = true;
        document.addEventListener("change", (e) => {
          if (e.target.id === "select-all") {
            document
              .querySelectorAll("#update-status-form input[name='voucher_ids']")
              .forEach((checkbox) => (checkbox.checked = e.target.checked));
          }
        });
      }

      /* --- Live JSON response updates --- */
      if (!window._voucherJsonHandlerBound) {
        window._voucherJsonHandlerBound = true;
        document.body.addEventListener("htmx:afterRequest", handleVoucherJsonResponse);
      }
    }

    /* ------------------------------------------------
     * Focus + Navigation Helpers
     * ------------------------------------------------ */
    function handleVoucherKeyboardNavigation(event) {
      const tableContainer = document.querySelector("#table-container");
      if (!tableContainer?._voucherState) return;

      const rows = Array.from(tableContainer.querySelectorAll(tableContainer._voucherState.rowSelector));
      if (!rows.length || !tableContainer._voucherState.activeVoucherId) return;

      const currentIndex = rows.findIndex(
        (row) => row.dataset.voucherId === tableContainer._voucherState.activeVoucherId,
      );
      if (currentIndex === -1) return;

      if (event.key === "ArrowDown") {
        event.preventDefault();
        setActiveVoucherByIndex(Math.min(currentIndex + 1, rows.length - 1), tableContainer);
      } else if (event.key === "ArrowUp") {
        event.preventDefault();
        setActiveVoucherByIndex(Math.max(currentIndex - 1, 0), tableContainer);
      }
    }

    function activateVoucherById(voucherId, container) {
      const rows = Array.from(container.querySelectorAll(container._voucherState.rowSelector));
      const index = rows.findIndex((row) => row.dataset.voucherId === String(voucherId));
      if (index !== -1) setActiveVoucherByIndex(index, container);
    }

    function setActiveVoucherByIndex(index, container) {
      const rows = Array.from(container.querySelectorAll(container._voucherState.rowSelector));
      if (!rows[index]) return;

      rows.forEach((row) => row.classList.remove("active-row"));
      const activeRow = rows[index];
      activeRow.classList.add("active-row");
      container._voucherState.activeVoucherId = String(activeRow.dataset.voucherId);

      activeRow.scrollIntoView({ block: "nearest" });
      try {
        activeRow.focus({ preventScroll: true });
      } catch {}

      const modalOpen = document.querySelector(".modal.show");
      const dropdownOpen = document.querySelector(".dropdown-menu.show");
      if (modalOpen || dropdownOpen) return;

      if (activeRow.dataset.voucherId) {
        htmx.ajax("GET", `/voucher/${activeRow.dataset.voucherId}/particulars`, "#voucher-details-preview");
      }
    }

    /* ------------------------------------------------
     * Handle JSON response for live status updates
     * ------------------------------------------------ */
    function handleVoucherJsonResponse(event) {
      const xhr = event.detail?.xhr;
      const contentType = xhr?.getResponseHeader("content-type") || "";
      if (!contentType.includes("application/json")) return;

      let data;
      try {
        data = JSON.parse(xhr.responseText || "{}");
      } catch {
        return;
      }
      if (!data.updated || !Array.isArray(data.updated)) return;

      data.updated.forEach(({ id, status, code, updated_at }) => {
        const badge = document.querySelector(`#voucher-${id} .status-col .badge`);
        const updatedAt = document.querySelector(`#voucher-${id} .status-col .updated_at`);
        if (!badge) return;

        badge.textContent = status;
        badge.className = "badge " + getStatusColorClass(code);
        badge.classList.add("flash");
        setTimeout(() => badge.classList.remove("flash"), 1000);

        if (updatedAt && updated_at) updatedAt.textContent = updated_at;
      });
    }

    function getStatusColorClass(code) {
      switch (code) {
        case "checked":
          return "bg-primary";
        case "sorted":
          return "bg-warning";
        case "approved":
          return "bg-success";
        case "returned":
          return "bg-danger";
        default:
          return "bg-secondary";
      }
    }

    /* ------------------------------------------------
     * Search Filter
     * ------------------------------------------------ */
    function bindVoucherSearchInput() {
      const searchInput = document.getElementById("voucher-search");
      if (!searchInput || searchInput._bound) return;
      searchInput._bound = true;

      searchInput.addEventListener("input", () => {
        const query = searchInput.value.toLowerCase();
        document.querySelectorAll(".voucher-row").forEach((row) => {
          row.style.display = row.textContent.toLowerCase().includes(query) ? "" : "none";
        });
      });
    }

    /* ------------------------------------------------
     * Handle HTMX Table Swap & Modal Restore
     * ------------------------------------------------ */
    document.body.addEventListener("htmx:afterSwap", (e) => {
      if (e.target.id === "table-container") {
        ensureVoucherRowIds();
        initializeVoucherTable();
        bindVoucherSearchInput();
      }
    });

    document.body.addEventListener("hidden.bs.modal", () => {
      const container = document.querySelector("#table-container");
      const activeId = container?._voucherState?.activeVoucherId;
      if (activeId) {
        const activeRow = document.querySelector(`#voucher-${activeId}`);
        if (activeRow) activeRow.focus({ preventScroll: true });
      }
    });

    document.body.addEventListener("htmx:afterSwap", (event) => {
      // When modal HTML is swapped into the modal container...
      if (event.target.id === "modal-container") {
        const modalEl = document.querySelector(".modal");
        if (modalEl) {
          // Get or create Bootstrap modal instance
          const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
          modal.show();
        }
      }
    });

    // Optional: clean up modal DOM after it's closed
    document.body.addEventListener("hidden.bs.modal", (event) => {
      event.target.remove(); // remove modal markup after hide
    });
  </script>
{% endblock %}

{% block style %}
  <style>
    .fragments {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 1rem;
      min-height: 0;
      overflow: hidden;
    }

    .plus-icon {
      vertical-align: middle;
    }

    .flash {
      animation: flash-bg 1s ease-in-out;
    }
    @keyframes flash-bg {
      from {
        background-color: #ffffa0;
      }
      to {
        background-color: inherit;
      }
    }
  </style>
{% endblock %}
