<form id="update-status-form">
  <table class="voucher-table">
    <thead>
      <tr>
        <th class="checkbox-col">
          <input type="checkbox" id="select-all" />
        </th>
        <th class="refnum-col text-start text-muted">Reference #</th>
        <th class="payee-col text-start text-muted">Payee</th>
        <th class="amount-col text-end text-muted">Amount</th>
        <th class="date-col text-start text-muted">Date Received</th>
        <th class="assto-col text-start text-muted">Assigned To</th>
        <th class="status-col text-muted">Status</th>
      </tr>
    </thead>

    <tbody>
      {% for voucher in vouchers %}
        <tr
          class="voucher-row"
          data-voucher-id="{{ voucher.id }}"
          tabindex="0"
          hx-get="{{ url_for('voucher.status_history', voucher_id=voucher.id) }}"
          hx-target="#voucher-details-preview"
          hx-swap="innerHTML"
        >
          <td class="checkbox-col">
            <input type="checkbox" name="voucher_ids" value="{{ voucher.id }}" />
          </td>
          <td class="refnum-col text-start">{{ voucher.reference_number }}</td>
          <td class="payee-col text-start fw-bold">{{ voucher.payee }}</td>
          <td class="amount-col text-end">{{ "{:,.2f}".format(voucher.amount) }}</td>
          <td class="date-col text-start">{{ voucher.date_received | local_time }}</td>
          <td class="assto-col text-start fw-bold">{{ voucher.assigned_to.name if voucher.assigned_to else "-" }}</td>
          <td class="status-col text-center">
            <span
              class="badge
              {% if voucher.status.code == 'checked' %}
                bg-warning
              {% elif voucher.status.code == 'sorted' %}
                bg-info
              {% elif voucher.status.code == 'approved' %}
                bg-success
              {% elif voucher.status.code == 'returned' %}
                bg-danger
              {% else %}
                bg-secondary
              {% endif %}"
            >
              {{ voucher.status.name }}
            </span>
          </td>
        </tr>
      {% else %}
        <tr>
          <td colspan="7" class="text-center text-muted">No vouchers found</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</form>

<script>
  // static/js/voucher-table.js
  (function () {
    if (window.__voucherTableBound) return;
    window.__voucherTableBound = true;

    // Handle select-all with event delegation
    document.addEventListener("change", (e) => {
      if (e.target.id === "select-all") {
        document
          .querySelectorAll("#update-status-form input[name='voucher_ids']")
          .forEach((cb) => (cb.checked = e.target.checked));
      }
    });

    // Re-check the "select all" box when table is swapped
    document.addEventListener("htmx:afterSwap", (e) => {
      if (e.target.id === "table-container") {
        const selectAll = document.getElementById("select-all");
        if (selectAll) selectAll.checked = false; // reset each refresh
      }
    });
  })();

  // Auto preview on focus
  document.addEventListener("DOMContentLoaded", function () {
    const container = document.querySelector("#table-container");
    const rows = Array.from(container.querySelectorAll(".voucher-row"));
    const preview = "#voucher-details-preview";
    let currentIndex = -1;

    // --- Core function to change focus/highlight + load details
    function setActive(idx) {
      if (idx < 0 || idx >= rows.length) return;

      if (currentIndex !== -1) rows[currentIndex].classList.remove("active-row");
      currentIndex = idx;

      const row = rows[idx];
      row.classList.add("active-row");
      row.focus({ preventScroll: true }); // keep keyboard focus for arrow keys
      row.scrollIntoView({ block: "nearest" });
    }

    // --- Click on row: focus & load
    rows.forEach((row, i) => row.addEventListener("click", () => setActive(i)));

    // --- Arrow-key navigation
    document.addEventListener("keydown", (e) => {
      if (currentIndex === -1) return;

      if (e.key === "ArrowDown") {
        e.preventDefault();
        setActive(Math.min(currentIndex + 1, rows.length - 1));
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        if (currentIndex > 0) {
          setActive(currentIndex - 1);
        } else {
          // already at first row: just keep focus, do not scroll
          rows[0].focus({ preventScroll: true });
        }
      }
    });

    // --- Remove highlight if user pans/scrolls with touchpad or mouse-wheel
    let scrollTimer;
    container.addEventListener("scroll", () => {
      if (scrollTimer) clearTimeout(scrollTimer);
      scrollTimer = setTimeout(() => {
        if (!document.activeElement || document.activeElement.tagName !== "TR") {
          // only clear if we aren't arrow-keying
          if (currentIndex !== -1) {
            rows[currentIndex].classList.remove("active-row");
            currentIndex = -1;
          }
        }
      }, 150); // fires shortly after user stops scrolling
    });

    // --- Auto-select first row on page load
    if (rows.length) setActive(0);
  });
</script>

<style>
  /* Modern table with equal column widths */
  .voucher-table {
    width: 100%;
    table-layout: fixed; /* equal-width columns */
    border-collapse: collapse;
    font-size: 0.85rem;
    max-height: 100%;
  }

  /* Narrow checkbox column */
  .voucher-table th.checkbox-col,
  .voucher-table td.checkbox-col {
    width: 1.5rem; /* or try 2rem if needed */
    padding-top: 1rem;
    text-align: center;
  }

  .voucher-table th,
  .voucher-table td {
    padding: 0.75rem 0.75rem; /* uniform padding */
    vertical-align: middle;
    overflow-wrap: break-word; /* wrap long words */
    word-break: break-word;
    white-space: normal; /* allow line breaks */
    border-bottom: 1px solid #dee2e6; /* subtle row separation */
  }

  .voucher-table thead th {
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    z-index: 2;
    background-color: white;
    font-weight: 600;
    text-align: center; /* center header text for better alignment */
  }

  .voucher-table tbody td {
    text-align: center; /* default center alignment */
  }

  /* Right-align amounts and dates for readability */
  .voucher-table td.text-end {
    text-align: right;
  }

  .voucher-table td {
    overflow: hidden;
    white-space: nowrap;
  }

  input[type="checkbox"] {
    accent-color: #0d6efd; /* Bootstrap 5 primary blue */
  }

  /* Custom column widths */
  .voucher-table th.refnum-col,
  .voucher-table td.refnum-col {
    width: 6rem;
  }

  .voucher-table th.payee-col,
  .voucher-table td.payee-col {
    width: 9rem;
  }

  .voucher-table th.amount-col,
  .voucher-table td.amount-col {
    width: 5rem;
  }

  .voucher-table th.date-col,
  .voucher-table td.date-col {
    width: 7rem;
  }

  .voucher-table th.assto-col,
  .voucher-table td.assto-col {
    width: 9rem;
  }

  .voucher-table th.status-col,
  .voucher-table td.status-col {
    width: 5rem;
  }
  /* highlight the row that is currently in view */
  .voucher-table tbody tr.active-row {
    background-color: #e7f1ff; /* light blue background */
    transition: background-color 0.2s ease-in-out;
  }
  .voucher-table tbody tr.active-row td {
    font-weight: 600; /* optional bold text */
  }

  .voucher-table tbody tr {
    scroll-margin-top: 40px; /* match or slightly exceed header height */
  }
</style>
