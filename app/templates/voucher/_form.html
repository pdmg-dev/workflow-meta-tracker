<!--app/templates/voucher/form.html-->
<form
  class="d-flex flex-column gap-2 h-100"
  hx-post="{{ url_for('voucher.new_voucher') }}"
  hx-target="#entry-form-container"
  hx-swap="innerHTML"
>
  {{ form.csrf_token() }}

  <div class="row g-2">
    <!-- Date Received -->
    <div class="col-md-4">
      <label for="date_received" class="form-label">Date Received</label>
      <div class="input-group position-relative td-datetime" id="date_received_group">
        <input
          type="text"
          class="form-control{{ ' is-invalid' if form.date_received.errors else '' }}"
          name="date_received"
          value="{{ form.date_received.data or '' }}"
          placeholder="mm/dd/yyyy hh:mm"
          required
          autofocus="true"
        />
        <span class="input-group-text" data-td-toggle="datetimepicker" data-td-target="#date_received_group">
          <i class="bi bi-calendar-event"></i>
        </span>

        {% for err in form.date_received.errors %}
          <div class="invalid-feedback d-block">{{ err }}</div>
        {% endfor %}
      </div>
    </div>

    <!-- Voucher Type -->
    <div class="col-md-4 position-relative">
      <label for="voucherTypeInput" class="form-label">Type</label>
      <input
        type="text"
        id="voucherTypeInput"
        class="form-control {{ 'is-invalid' if form.voucher_type.errors else '' }}"
        placeholder="e.g. Salary"
        value="{% if form.voucher_type.data %}{{ dict(form.voucher_type.choices).get(form.voucher_type.data) }}{% endif %}"
        autocomplete="off"
      />
      <ul
        id="voucherTypeSuggestions"
        class="list-group position-absolute w-100 shadow-sm"
        style="z-index: 1000; display:none; max-height: 200px; overflow-y:auto;"
      >
        {% for value, label in form.voucher_type.choices %}
          <li class="list-group-item suggestion-item" data-value="{{ value }}">{{ label }}</li>
        {% endfor %}
      </ul>

      <input type="hidden" name="voucher_type" id="voucherTypeHidden" value="{{ form.voucher_type.data or '' }}" />

      {% for err in form.voucher_type.errors %}
        <div class="invalid-feedback d-block">{{ err }}</div>
      {% endfor %}
    </div>

    <!-- Origin -->
    <div class="col-md-4 position-relative">
      <label for="originInput" class="form-label">Origin</label>
      <input
        type="text"
        id="originInput"
        name="origin"
        class="form-control {{ 'is-invalid' if form.origin.errors else '' }}"
        placeholder="e.g. Accounting or 1081"
        value="{{ form.origin.data or '' }}"
        autocomplete="off"
      />

      <ul
        id="originSuggestions"
        class="list-group position-absolute w-100 shadow-sm"
        style="z-index:1000; display:none; max-height:200px; overflow-y:auto;"
      >
        {% for o in form.origins %}
          <li
            class="list-group-item suggestion-item"
            data-id="{{ o.id }}"
            data-code="{{ o.code }}"
            data-name="{{ o.name }}"
            data-keyword="{{ o.keyword or o.name }}"
          >
            {{ o.keyword }} ({{ o.code }})
          </li>
        {% endfor %}
      </ul>

      <input type="hidden" name="origin_id" id="originHidden" value="{{ form.origin_id.data or '' }}" />

      {% for err in form.origin.errors %}
        <div class="invalid-feedback d-block">{{ err }}</div>
      {% endfor %}
    </div>

    <!-- Payee -->
    <div class="col-md-8">
      {{ form.payee.label(class="form-label") }}
      {{
        form.payee(
             class="form-control" + (' is-invalid' if form.payee.errors else ''),
             maxlength=120,
             required=True,
             placeholder="e.g. Juan Dela Cruz",
        )
      }}
      {% for err in form.payee.errors %}
        <div class="invalid-feedback">{{ err }}</div>
      {% endfor %}
    </div>

    <!-- Amount -->
    <div class="col-md-4">
      {{ form.amount.label(class="form-label") }}
      {{
        form.amount(
          class="form-control" + (' is-invalid' if form.amount.errors else ''),
          type="text",
          required=True,
          placeholder="0.00",
          onfocus="stripFormat(this)",
          onblur="applyFormat(this, 15, 2)"
        )
      }}
      {% for err in form.amount.errors %}
        <div class="invalid-feedback">{{ err }}</div>
      {% endfor %}
    </div>
  </div>

  <div class="row h-100">
    <!-- Particulars -->
    <div class="col-12 d-flex flex-column flex-grow-1">
      {{ form.particulars.label(class="form-label") }}
      <div class="flex-wrapper flex-grow-1">
        {{
          form.particulars(
               class="form-control" + (' is-invalid' if form.particulars.errors else ''),
               maxlength=2000,
               required=True
          )
        }}
      </div>
      {% for err in form.particulars.errors %}
        <div class="invalid-feedback">{{ err }}</div>
      {% endfor %}
    </div>
  </div>

  <div class="d-flex justify-content-end">
    <button type="submit" class="btn btn-primary"><i class="bi bi-floppy me-1"></i> Save</button>
  </div>
</form>

<div class="position-absolute bottom-0 start-0 mb-3 ms-3">
  <a
    hx-get="{{ url_for('voucher.new_voucher', clear_form='true') }}"
    hx-target="#entry-form-container"
    hx-swap="innerHTML"
    class="btn btn-outline-secondary"
  >
    <i class="bi bi-x-lg me-1"></i>Cancel
  </a>
</div>

<script>
  (() => {
    // ========= 1) Global one-time listeners =========
    if (window.__voucherFormBound) return;
    window.__voucherFormBound = true;

    const FORM_CONTAINER_ID = "entry-form-container";

    const focusElementSafely = (el) => {
      if (!el) return;
      try {
        el.focus({ preventScroll: true });
      } catch {
        el.focus();
      }
    };

    const getFirstFocusableField = (c) =>
      c.querySelector("[data-autofocus]") ||
      c.querySelector(
        "select:not([disabled]), input:not([disabled]), textarea:not([disabled]), button:not([disabled]), [tabindex]:not([tabindex='-1'])",
      );

    const focusFirstInvalidField = (c) => {
      const invalid = c.querySelector("input.is-invalid, select.is-invalid, textarea.is-invalid, button.is-invalid");
      if (!invalid) return false;
      focusElementSafely(invalid);
      return true;
    };

    const focusFirstField = (c) => focusElementSafely(getFirstFocusableField(c));

    document.addEventListener("voucherSaved", () => {
      showToast("Voucher saved successfully.", "success");
      const c = document.getElementById(FORM_CONTAINER_ID);
      if (!c) return;
      requestAnimationFrame(() =>
        setTimeout(() => {
          if (!focusFirstInvalidField(c)) focusFirstField(c);
        }, 50),
      );
    });

    document.addEventListener("htmx:afterSwap", (e) => {
      const c = e.detail?.target;
      if (c?.id !== FORM_CONTAINER_ID) return;
      requestAnimationFrame(() =>
        setTimeout(() => {
          if (!focusFirstInvalidField(c)) focusFirstField(c);
        }, 50),
      );
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && e.ctrlKey) {
        const f = e.target.closest("form");
        if (f) {
          e.preventDefault();
          f.requestSubmit();
        }
      }
    });

    const setSubmitState = (form, disabled) =>
      form.querySelector("button[type=submit]")?.toggleAttribute("disabled", disabled);
    document.addEventListener("htmx:beforeRequest", (e) => {
      const f = e.target.closest("form");
      if (f) setSubmitState(f, true);
    });
    document.addEventListener("htmx:afterRequest", (e) => {
      const f = e.target.closest("form");
      if (f) setSubmitState(f, false);
    });

    // ================== Origin autocomplete ==================
    function initOriginAutocomplete(container = document) {
      const input = container.querySelector("#originInput");
      const suggestions = container.querySelector("#originSuggestions");
      const hidden = container.querySelector("#originHidden");

      if (!input || !suggestions || !hidden || input.__bound) return;
      input.__bound = true;
      let activeIndex = -1;

      function updateHighlight(items) {
        items.forEach((item, i) => item.classList.toggle("active", i === activeIndex));
      }

      input.addEventListener("input", () => {
        const term = input.value.toLowerCase().trim();
        let hasMatch = false;
        const items = Array.from(suggestions.querySelectorAll(".suggestion-item"));
        items.forEach((item) => {
          const text = item.textContent.toLowerCase();
          const code = (item.dataset.code || "").toLowerCase();
          const name = (item.dataset.name || "").toLowerCase();
          const keyword = (item.dataset.keyword || "").toLowerCase();
          const match = text.includes(term) || code.includes(term) || name.includes(term) || keyword.includes(term);
          item.style.display = match ? "" : "none";
          if (match) hasMatch = true;
        });
        suggestions.style.display = hasMatch ? "block" : "none";
        activeIndex = -1;
        updateHighlight(items);
      });

      input.addEventListener("keydown", (e) => {
        const visibleItems = Array.from(suggestions.querySelectorAll(".suggestion-item")).filter(
          (i) => i.style.display !== "none",
        );
        if (!visibleItems.length || suggestions.style.display !== "block") return;

        if (e.key === "ArrowDown") {
          e.preventDefault();
          activeIndex = (activeIndex + 1) % visibleItems.length;
          updateHighlight(visibleItems);
          visibleItems[activeIndex].scrollIntoView({ block: "nearest" });
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          activeIndex = (activeIndex - 1 + visibleItems.length) % visibleItems.length;
          updateHighlight(visibleItems);
          visibleItems[activeIndex].scrollIntoView({ block: "nearest" });
        } else if (e.key === "Enter") {
          if (activeIndex >= 0) {
            e.preventDefault();
            const choice = visibleItems[activeIndex];
            input.value = choice.dataset.keyword || choice.textContent.trim();
            hidden.value = choice.dataset.id;
            suggestions.style.display = "none";
            console.log("Enter set origin_id:", hidden.value);
          }
        } else if (e.key === "Escape") {
          suggestions.style.display = "none";
        }
      });

      suggestions.querySelectorAll(".suggestion-item").forEach((item) => {
        if (item.__bound) return;
        item.__bound = true;
        item.addEventListener("click", () => {
          input.value = item.dataset.keyword || item.textContent.trim();
          hidden.value = item.dataset.id;
          suggestions.style.display = "none";
          console.log("Click set origin_id:", hidden.value);
        });
      });
    }

    // ================== Voucher Form ==================
    function initVoucherForm(container = document) {
      const input = container.querySelector("#voucherTypeInput");
      const hidden = container.querySelector("#voucherTypeHidden");
      const suggestions = container.querySelector("#voucherTypeSuggestions");

      if (input && hidden && suggestions && !input.__bound) {
        input.__bound = true;

        let activeIndex = -1;

        function updateHighlight(items) {
          items.forEach((item, i) => {
            item.classList.toggle("active", i === activeIndex);
          });
        }

        input.addEventListener("input", () => {
          const term = input.value.toLowerCase();
          let hasMatch = false;

          const items = Array.from(suggestions.querySelectorAll(".suggestion-item"));
          items.forEach((item) => {
            const match = item.textContent.toLowerCase().includes(term);
            item.style.display = match ? "" : "none";
            if (match) hasMatch = true;
          });

          suggestions.style.display = hasMatch ? "block" : "none";
          activeIndex = -1;
          updateHighlight(items);
        });

        input.addEventListener("keydown", (e) => {
          const visibleItems = Array.from(suggestions.querySelectorAll(".suggestion-item")).filter(
            (item) => item.style.display !== "none",
          );

          if (suggestions.style.display !== "block" || visibleItems.length === 0) return;

          if (e.key === "ArrowDown") {
            e.preventDefault();
            activeIndex = (activeIndex + 1) % visibleItems.length;
            updateHighlight(visibleItems);
            visibleItems[activeIndex].scrollIntoView({ block: "nearest" });
          } else if (e.key === "ArrowUp") {
            e.preventDefault();
            activeIndex = (activeIndex - 1 + visibleItems.length) % visibleItems.length;
            updateHighlight(visibleItems);
            visibleItems[activeIndex].scrollIntoView({ block: "nearest" });
          } else if (e.key === "Enter") {
            if (activeIndex >= 0) {
              e.preventDefault();
              const choice = visibleItems[activeIndex];
              input.value = choice.textContent;
              hidden.value = choice.dataset.value;
              suggestions.style.display = "none";
            }
          } else if (e.key === "Escape") {
            suggestions.style.display = "none";
          }
        });

        suggestions.querySelectorAll(".suggestion-item").forEach((item) => {
          if (item.__bound) return;
          item.__bound = true;
          item.addEventListener("click", () => {
            input.value = item.textContent;
            hidden.value = item.dataset.value;
            suggestions.style.display = "none";
          });
        });

        document.addEventListener("click", (e) => {
          if (!suggestions.contains(e.target) && e.target !== input) {
            suggestions.style.display = "none";
          }
        });
      }

      initOriginAutocomplete(container);
      restrictAmountInput(container);

      // ==== Fund Dropdown (old dropdown) ====
      container.querySelectorAll("#fundDropdown + .dropdown-menu .dropdown-item").forEach((item) => {
        if (item.__bound) return;
        item.__bound = true;
        item.addEventListener("click", (e) => {
          document.getElementById("fundDropdown").textContent = e.target.textContent;
          document.getElementById("fundHidden").value = e.target.dataset.value;
        });
      });

      // ==== Tempus Dominus datepicker ====
      container.querySelectorAll(".td-datetime").forEach((group) => {
        if (!window.tempusDominus) {
          console.error("Tempus Dominus library not found.");
          return;
        }

        if (group.__td_instance) {
          try {
            group.__td_instance.dispose();
          } catch (err) {
            console.warn("Failed to dispose old Tempus Dominus instance", err);
          }
          group.__td_instance = null;
        }

        group.__td_instance = new tempusDominus.TempusDominus(group, {
          keepInvalid: true,
          useCurrent: true,
          localization: {
            format: "MM/dd/yyyy hh:mm T",
            hourCycle: "h12",
            locale: "en",
          },
          display: {
            theme: "light",
            icons: {
              type: "icons",
              time: "bi bi-clock",
              date: "bi bi-calendar-week",
              up: "bi bi-arrow-up",
              down: "bi bi-arrow-down",
              previous: "bi bi-chevron-left",
              next: "bi bi-chevron-right",
              today: "bi bi-calendar-check",
              clear: "bi bi-trash",
              close: "bi bi-x",
            },
            buttons: { today: true, clear: true },
            components: {
              calendar: true,
              date: true,
              month: true,
              year: true,
              decades: false,
              clock: true,
              hours: true,
              minutes: true,
              seconds: false,
            },
          },
        });
      });
    }

    // ================== Amount Cleaner ==================
    function cleanAmountBeforeSubmit(form) {
      const el = form.querySelector('[name="amount"]');
      if (el) {
        el.value = el.value.replace(/,/g, "");
      }
    }

    function attachAmountCleaner(container = document) {
      container.querySelectorAll("form").forEach((form) => {
        if (form.__cleanBound) return;
        form.__cleanBound = true;

        form.addEventListener("submit", () => {
          cleanAmountBeforeSubmit(form);
        });
      });
    }

    // ================== Init ==================
    document.addEventListener("htmx:afterSwap", (e) => {
      if (e.detail?.target?.id === "entry-form-container") {
        initVoucherForm(e.detail.target);
        attachAmountCleaner(e.detail.target);
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      initVoucherForm();
      attachAmountCleaner();
    });

    // ================== Optional helpers for inline use ==================
    window.stripFormat = function stripFormat(el) {
      el.value = el.value.replace(/,/g, "");
    };

    window.applyFormat = function applyFormat(el, maxLength, decimals) {
      let val = el.value.replace(/,/g, "");
      let [intPart, decPart] = val.split(".");

      if (intPart.length > maxLength) {
        intPart = intPart.slice(0, maxLength);
      }
      if (decPart && decimals > 0) {
        decPart = decPart.slice(0, decimals);
      }

      intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      el.value = decPart !== undefined ? `${intPart}.${decPart}` : intPart;
    };

    function restrictAmountInput(container = document) {
      const el = container.querySelector('[name="amount"]');
      if (!el || el.__bound) return;
      el.__bound = true;

      el.addEventListener("input", () => {
        // allow only digits, comma, period
        el.value = el.value.replace(/[^0-9.,]/g, "");
      });

      el.addEventListener("keydown", (e) => {
        if (["Backspace", "Delete", "ArrowLeft", "ArrowRight", "Tab"].includes(e.key) || e.ctrlKey || e.metaKey) {
          return;
        }
        if (/^[0-9.,]$/.test(e.key)) {
          return;
        }
        e.preventDefault();
      });
    }
  })();
</script>

{% block style %}
  <style>
    .flex-wrapper {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }

    .flex-wrapper .form-control {
      flex-grow: 1;
      resize: none;
    }

    .small-placeholder::placeholder {
      font-size: 0.875rem; /* Bootstrap's .small font size */
    }
  </style>
{% endblock %}
