<!--app/templates/voucher/form.html-->
<form
  class="d-flex flex-column gap-2 h-100"
  hx-post="{{ url_for('voucher.new_voucher') }}"
  hx-target="#entry-form-container"
  hx-swap="innerHTML"
>
  {{ form.hidden_tag() }}

  <div class="row g-2">
    <!-- Voucher Type -->
    <div class="col-md-4">
      {{ form.voucher_type.label(class="form-label") }}
      {{
        form.voucher_type(
             class="form-select" + (' is-invalid' if form.voucher_type.errors else ''),
             required=True,
             id="voucher_type",
             data_autofocus="true"
        )
      }}
      {% for err in form.voucher_type.errors %}
        <div class="invalid-feedback">{{ err }}</div>
      {% endfor %}
    </div>

    <!-- Origin -->
    <div class="col-md-4 position-relative">
      {{ form.origin.label(class="form-label") }}
      {{
        form.origin(
             class="form-control" + (' is-invalid' if form.origin.errors else ''),
             maxlength=120,
             required=True,
             id="originInput"
        )
      }}
      <div class="dropdown-menu" id="originSuggestions"></div>

      {% for err in form.origin.errors %}
        <div class="invalid-feedback">{{ err }}</div>
      {% endfor %}
    </div>

    <!-- Date Received -->
    <div class="col-md-4">
      {{ form.date_received.label(class="form-label") }}
      {{
        form.date_received(
             class="form-control" + (' is-invalid' if form.date_received.errors else ''),
             type="datetime-local",
             required=True,
             id="date_received",
             value=form.date_received.data.strftime('%Y-%m-%dT%H:%M')
                   if form.date_received.data else ''
        )
      }}
      {% for err in form.date_received.errors %}
        <div class="invalid-feedback">{{ err }}</div>
      {% endfor %}
    </div>

    <!-- Payee -->
    <div class="col-md-8">
      {{ form.payee.label(class="form-label") }}
      {{
        form.payee(
             class="form-control" + (' is-invalid' if form.payee.errors else ''),
             maxlength=120,
             required=True
        )
      }}
      {% for err in form.payee.errors %}
        <div class="invalid-feedback">{{ err }}</div>
      {% endfor %}
    </div>

    <!-- Amount -->
    <div class="col-md-4">
      {{ form.amount.label(class="form-label") }}
      {{
        form.amount(
             class="form-control" + (' is-invalid' if form.amount.errors else ''),
             type="number",
             step="0.01",
             min="0.01",
             inputmode="decimal",
             required=True,
             oninput="limitDigits(this, 8, 2)"
        )
      }}
      {% for err in form.amount.errors %}
        <div class="invalid-feedback">{{ err }}</div>
      {% endfor %}
    </div>
  </div>

  <!-- Particulars -->
  <div class="col-12 d-flex flex-column flex-grow-1">
    {{ form.particulars.label(class="form-label") }}
    <div class="flex-wrapper flex-grow-1">
      {{
        form.particulars(
             class="form-control" + (' is-invalid' if form.particulars.errors else ''),
             maxlength=2000,
             required=True,
        )
      }}
    </div>
    {% for err in form.particulars.errors %}
      <div class="invalid-feedback">{{ err }}</div>
    {% endfor %}
  </div>
  <div class="d-flex justify-content-between">
    <a href="{{ url_for('tracker.view_vouchers') }}" class="btn btn-outline-secondary">Cancel</a>
    <button type="submit" class="btn btn-primary">Save</button>
  </div>
</form>

<script>
  (() => {
    // Use a global flag to ensure all event listeners bind only once.
    if (window.__voucherFormBound) return;
    window.__voucherFormBound = true;

    const FORM_CONTAINER_ID = "entry-form-container";

    // Safely focus an element without scrolling the page
    const focusElementSafely = (element) => {
      if (!element) return;
      try {
        element.focus({ preventScroll: true });
      } catch {
        element.focus();
      }
    };

    // Get the first focusable field in a container
    const getFirstFocusableField = (formContainer) => {
      return (
        formContainer.querySelector("[data-autofocus]") ||
        formContainer.querySelector(
          "select:not([disabled]), input:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex='-1'])",
        )
      );
    };

    // Focus the first field in the container
    const focusFirstFieldInContainer = (formContainer) => {
      focusElementSafely(getFirstFocusableField(formContainer));
    };

    // Focus the first field that currently has a validation error
    const focusFirstInvalidField = (formContainer) => {
      const invalidField = formContainer.querySelector("input.is-invalid, select.is-invalid, textarea.is-invalid");
      if (!invalidField) return false;
      focusElementSafely(invalidField);
      return true;
    };

    /* HTMX may swap the form even on success, so we wait for the next paint 
    and a small timeout to ensure DOM classes are applied.
    Focus first invalid field if it exists, else focus first field. */
    document.addEventListener("voucherSaved", () => {
      showToast("Voucher saved successfully.", "success");

      const formContainer = document.getElementById(FORM_CONTAINER_ID);
      if (!formContainer) return;

      requestAnimationFrame(() => {
        setTimeout(() => {
          if (!focusFirstInvalidField(formContainer)) {
            focusFirstFieldInContainer(formContainer);
          }
        }, 50); // Small delay gives browser time to apply DOM updates
      });
    });

    // Focus logic after HTMX swaps the form (for validation errors)
    document.addEventListener("htmx:afterSwap", (event) => {
      const formContainer = event.detail?.target;
      if (!formContainer || formContainer.id !== FORM_CONTAINER_ID) return;

      requestAnimationFrame(() => {
        if (focusFirstInvalidField(formContainer)) return;

        setTimeout(() => {
          if (!focusFirstInvalidField(formContainer)) {
            focusFirstFieldInContainer(formContainer);
          }
        }, 50); // Allow browser to update classes/styles
      });
    });

    // Keyboard shortcut: Ctrl+Enter submits the form
    document.addEventListener("keydown", (event) => {
      if (event.key === "Enter" && event.ctrlKey) {
        const currentForm = event.target?.closest("form");
        if (currentForm) {
          event.preventDefault();
          currentForm.requestSubmit(); // Modern method to submit programmatically
        }
      }
    });

    // Disable submit button during HTMX requests
    // Prevent double submission by disabling the submit button
    // before the request and re-enable after it completes
    const setSubmitButtonState = (form, disabled) => {
      const submitButton = form.querySelector("button[type=submit]");
      if (submitButton) submitButton.disabled = disabled;
    };

    document.addEventListener("htmx:beforeRequest", (event) => {
      const currentForm = event.target?.closest("form");
      if (currentForm) setSubmitButtonState(currentForm, true);
    });

    document.addEventListener("htmx:afterRequest", (event) => {
      const currentForm = event.target?.closest("form");
      if (currentForm) setSubmitButtonState(currentForm, false);
    });
  })();

  // Limit the number of digits to input in amount
  function limitDigits(input, maxWhole, maxDecimal) {
    let value = input.value;
    let [whole, decimal = ""] = value.split(".");
    if (whole.length > maxWhole) {
      whole = whole.slice(0, maxWhole);
    }
    if (decimal.length > maxDecimal) {
      decimal = decimal.slice(0, maxDecimal);
    }
    input.value = decimal ? `${whole}.${decimal}` : whole;
  }

  document.addEventListener("input", async (e) => {
    if (!e.target.matches("#originInput")) return;

    const originInput = e.target;
    const suggestionsBox = originInput.closest(".position-relative").querySelector("#originSuggestions");

    const q = originInput.value.trim();
    if (!q) {
      suggestionsBox.classList.remove("show");
      return;
    }

    const res = await fetch(`/voucher/origin-suggest?q=${encodeURIComponent(q)}`);
    const data = await res.json();

    suggestionsBox.innerHTML = "";
    data.forEach((name) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "dropdown-item";
      btn.textContent = name;
      btn.onclick = () => {
        originInput.value = name;
        suggestionsBox.classList.remove("show");
      };
      suggestionsBox.appendChild(btn);
    });
    suggestionsBox.classList.toggle("show", data.length > 0);
  });

  document.addEventListener("click", (e) => {
    if (!e.target.closest("#originInput")) {
      document.getElementById("originSuggestions")?.classList.remove("show");
    }
  });
</script>

{% block style %}
  <style>
    .flex-wrapper {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }

    .flex-wrapper .form-control {
      flex-grow: 1;
      resize: none;
    }
  </style>
{% endblock %}