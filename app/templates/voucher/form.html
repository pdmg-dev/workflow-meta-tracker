<!--app/templates/voucher/form.html-->
<form
  class="d-flex flex-column gap-2 h-100"
  hx-post="{{ url_for('voucher.new_voucher') }}"
  hx-target="#entry-form-container"
  hx-swap="innerHTML"
>
  {{ form.hidden_tag() }}
  <div class="row g-2">
    <!-- Type -->
    <div class="col-md-4">
      <label for="typeDropdown" class="form-label">Type</label>
      <div class="dropdown w-100">
        <button
          class="form-select w-100 text-start d-flex justify-content-between align-items-center
             {{ 'is-invalid' if form.voucher_type.errors else '' }}"
          type="button"
          id="typeDropdown"
          data-bs-toggle="dropdown"
          aria-expanded="false"
        >
          {{ dict(form.voucher_type.choices).get(form.voucher_type.data, 'Select Type') }}
        </button>
        <ul class="dropdown-menu w-100 overflow-auto" style="max-height: 200px;" aria-labelledby="typeDropdown">
          {% for value, label in form.voucher_type.choices %}
            <li>
              <button class="dropdown-item" type="button" data-value="{{ value }}">{{ label }}</button>
            </li>
          {% endfor %}
        </ul>
        <input type="hidden" name="voucher_type" id="voucherTypeHidden" value="{{ form.voucher_type.data or '' }}" />
        {% for err in form.voucher_type.errors %}
          <div class="invalid-feedback d-block">{{ err }}</div>
        {% endfor %}
      </div>
    </div>

    <!-- Origin -->
    <div class="col-md-4">
      <label for="originDropdown" class="form-label">Origin</label>
      <div class="dropdown w-100">
        <button
          class="form-select w-100 text-start d-flex justify-content-between align-items-center
             {{ 'is-invalid' if form.origin.errors else '' }}"
          type="button"
          id="originDropdown"
          data-bs-toggle="dropdown"
          aria-expanded="false"
        >
          {{ dict(form.origin.choices).get(form.origin.data, 'Select Origin') }}
        </button>
        <ul class="dropdown-menu w-100 overflow-auto" style="max-height: 200px;" aria-labelledby="originDropdown">
          {% for value, label in form.origin.choices %}
            <li>
              <button class="dropdown-item" type="button" data-value="{{ value }}">{{ label }}</button>
            </li>
          {% endfor %}
        </ul>
        <input type="hidden" name="origin" id="originHidden" value="{{ form.origin.data or '' }}" />
        {% for err in form.origin.errors %}
          <div class="invalid-feedback d-block">{{ err }}</div>
        {% endfor %}
      </div>
    </div>

    <!-- Date Received -->
    <div class="col-md-4">
      <label for="date_received" class="form-label">Date Received</label>
      <div class="input-group position-relative" id="datePickerWrapper">
        <input
          type="text"
          class="form-control{{ ' is-invalid' if form.date_received.errors else '' }}"
          id="date_received"
          name="date_received"
          value="{{ date_received_value }}"
          required
        />
        <span class="input-group-text" data-td-toggle="datetimepicker" data-td-target="#datePickerWrapper">
          <i class="bi bi-calendar-event"></i>
        </span>
        {% for err in form.date_received.errors %}
          <div class="invalid-feedback d-block">{{ err }}</div>
        {% endfor %}
      </div>
    </div>

    <!-- Payee -->
    <div class="col-md-8">
      {{ form.payee.label(class="form-label") }}
      {{
        form.payee(
             class="form-control" + (' is-invalid' if form.payee.errors else ''),
             maxlength=120,
             required=True,
             **{'data-autofocus': True}
        )
      }}
      {% for err in form.payee.errors %}
        <div class="invalid-feedback">{{ err }}</div>
      {% endfor %}
    </div>

    <!-- Amount -->
    <div class="col-md-4">
      {{ form.amount.label(class="form-label") }}
      {{
        form.amount(
             class="form-control" + (' is-invalid' if form.amount.errors else ''),
             type="number",
             step="0.01",
             min="0.01",
             inputmode="decimal",
             required=True,
             oninput="limitDigits(this, 8, 2)"
        )
      }}
      {% for err in form.amount.errors %}
        <div class="invalid-feedback">{{ err }}</div>
      {% endfor %}
    </div>
  </div>

  <!-- Particulars -->
  <div class="col-12 d-flex flex-column flex-grow-1">
    {{ form.particulars.label(class="form-label") }}
    <div class="flex-wrapper flex-grow-1">
      {{
        form.particulars(
             class="form-control" + (' is-invalid' if form.particulars.errors else ''),
             maxlength=2000,
             required=True,
        )
      }}
    </div>
    {% for err in form.particulars.errors %}
      <div class="invalid-feedback">{{ err }}</div>
    {% endfor %}
  </div>
  <div class="d-flex justify-content-between">
    <a hx-get="{{ url_for('voucher.new_voucher', clear_form='true') }}" hx-swap="none" class="btn btn-outline-secondary"
      ><i class="bi bi-x-lg me-1"></i>Cancel</a
    >
    <button type="submit" class="btn btn-primary"><i class="bi bi-floppy me-1"></i> Save</button>
  </div>
</form>

<script>
  (() => {
    // ========= 1) Global one-time listeners =========
    if (window.__voucherFormBound) return;
    window.__voucherFormBound = true;

    const FORM_CONTAINER_ID = "entry-form-container";

    const focusElementSafely = (el) => {
      if (!el) return;
      try {
        el.focus({ preventScroll: true });
      } catch {
        el.focus();
      }
    };

    const getFirstFocusableField = (c) =>
      c.querySelector("[data-autofocus]") ||
      c.querySelector(
        "select:not([disabled]), input:not([disabled]), textarea:not([disabled]), button:not([disabled]), [tabindex]:not([tabindex='-1'])",
      );

    const focusFirstInvalidField = (c) => {
      const invalid = c.querySelector("input.is-invalid, select.is-invalid, textarea.is-invalid, button.is-invalid");
      if (!invalid) return false;
      focusElementSafely(invalid);
      return true;
    };

    const focusFirstField = (c) => focusElementSafely(getFirstFocusableField(c));

    document.addEventListener("voucherSaved", () => {
      showToast("Voucher saved successfully.", "success");
      const c = document.getElementById(FORM_CONTAINER_ID);
      if (!c) return;
      requestAnimationFrame(() =>
        setTimeout(() => {
          if (!focusFirstInvalidField(c)) focusFirstField(c);
        }, 50),
      );
    });

    document.addEventListener("htmx:afterSwap", (e) => {
      const c = e.detail?.target;
      if (c?.id !== FORM_CONTAINER_ID) return;
      requestAnimationFrame(() =>
        setTimeout(() => {
          if (!focusFirstInvalidField(c)) focusFirstField(c);
        }, 50),
      );
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && e.ctrlKey) {
        const f = e.target.closest("form");
        if (f) {
          e.preventDefault();
          f.requestSubmit();
        }
      }
    });

    const setSubmitState = (form, disabled) =>
      form.querySelector("button[type=submit]")?.toggleAttribute("disabled", disabled);
    document.addEventListener("htmx:beforeRequest", (e) => {
      const f = e.target.closest("form");
      if (f) setSubmitState(f, true);
    });
    document.addEventListener("htmx:afterRequest", (e) => {
      const f = e.target.closest("form");
      if (f) setSubmitState(f, false);
    });

    // ========= 2) Per-swap initializer =========
    function initVoucherForm(container = document) {
      // Dropdowns – guard each item so we only attach once
      container.querySelectorAll("#typeDropdown + .dropdown-menu .dropdown-item").forEach((item) => {
        if (item.__bound) return;
        item.__bound = true;
        item.addEventListener("click", (e) => {
          document.getElementById("typeDropdown").textContent = e.target.textContent;
          document.getElementById("voucherTypeHidden").value = e.target.dataset.value;
        });
      });

      container.querySelectorAll("#originDropdown + .dropdown-menu .dropdown-item").forEach((item) => {
        if (item.__bound) return;
        item.__bound = true;
        item.addEventListener("click", (e) => {
          document.getElementById("originDropdown").textContent = e.target.textContent;
          document.getElementById("originHidden").value = e.target.dataset.value;
        });
      });

      // Tempus Dominus date picker – guard each input
      container.querySelectorAll("#datePickerWrapper").forEach((wrapper) => {
        if (wrapper.__td_initialized) return;
        if (!window.tempusDominus) {
          console.error("Tempus Dominus library not found.");
          return;
        }
        const picker = new tempusDominus.TempusDominus(wrapper, {
          localization: { format: "MM/dd/yyyy hh:mm T" },
          display: {
            theme: "light",
            icons: {
              type: "icons",
              time: "bi bi-clock",
              date: "bi bi-calendar-week",
              up: "bi bi-arrow-up",
              down: "bi bi-arrow-down",
              previous: "bi bi-chevron-left",
              next: "bi bi-chevron-right",
              today: "bi bi-calendar-check",
              clear: "bi bi-trash",
              close: "bi bi-x",
            },
            buttons: { today: true, clear: true },
            components: {
              calendar: true,
              date: true,
              month: true,
              year: true,
              decades: false,
              clock: true,
              hours: true,
              minutes: true,
              seconds: false,
            },
          },
        });

        wrapper.__td_initialized = true;
        wrapper.__td_instance = picker;
      });
    }

    // Initial page load
    document.addEventListener("DOMContentLoaded", () => initVoucherForm());

    // Re-initialize after each HTMX swap of the form container
    document.addEventListener("htmx:afterSwap", (e) => {
      if (e.detail?.target?.id === FORM_CONTAINER_ID) {
        initVoucherForm(e.detail.target);
      }
    });

    // Optional numeric digit limiter for Amount
    window.limitDigits = function (input, maxWhole, maxDecimal) {
      let [whole, decimal = ""] = input.value.split(".");
      if (whole.length > maxWhole) whole = whole.slice(0, maxWhole);
      if (decimal.length > maxDecimal) decimal = decimal.slice(0, maxDecimal);
      input.value = decimal ? `${whole}.${decimal}` : whole;
    };
  })();
</script>

{% block style %}
  <style>
    .flex-wrapper {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }

    .flex-wrapper .form-control {
      flex-grow: 1;
      resize: none;
    }
  </style>
{% endblock %}
